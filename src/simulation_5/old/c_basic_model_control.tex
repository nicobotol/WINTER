\newpage
\section{Control strategies formulation}\label{sec:c_basic_model_control}
In this section, the different control blocks are described, focusing in particular on the generator and the blade pitching. \\
For what concerns the generator, first of all the basic idea behind the control is presented and then implemented according two different approaches. Secondly the low level control of the electrical machine is described.\\
For what concerns the blade pitch control, the method implemented is firstly exposed in its theoretical concepts, then it is validated on the NREL 5 MW wind turbine (since more data for benchmarking the process are available) and finally implemented for the DTU 10 MW.   

\textcolor{red}{Unire 7.1 e 7.2 e cambiare i titoli di conseguenza}

\subsection{Generator's torque reference synthesis based on rotor}\label{subsec:torque_reference}
In this section the main idea used for controlling the generated power are described. This approach is in some sense general, and in fact it will be firstly applied here and then also on \autoref{subsec:method_control_P_GE}. The difference between the two is that now (as presented in \cite{Aerodynamics_of_wind_turbines} and \cite{SMILDEN2016386}) the focus is on the power extracted from the resource while later it will be the power produced by the generator.

\subsubsection[Below rated WS]{Generator's torque reference based on rotor below rated WS}\label{subsec:below_rotor}
As said before, below the rated WS the objective is to ensure the maximum power extraction from the resource, and so working at the maximum power coefficient. If initially the damping is not considered, then the generator torque can be rewritten as:
\begin{gather}
    T_G=\frac{P_G}{\omega_G}=\frac{P_R}{\omega_G}=\frac{\frac{1}{2}\rho c_{P,MAX} \pi R^2 V_0^3}{\omega_G} \ \ \left[\si{\newton\meter}\right]
    \label{eq:T_G1}
\end{gather}
then the \acrshort{WS} can be rewritten as
\begin{equation}
    \lambda_{opt} = \frac{\omega_R R}{V_0} = \frac{n \omega_G R}{V_0} \Rightarrow V_0=\frac{n\omega_G R}{\lambda_{opt}}  \ \ \left[\si{\meter\per\second}\right]
    \label{eq:lambda_opt}
\end{equation}
By replacing \autoref{eq:lambda_opt} into \autoref{eq:T_G1} then the drivetrain torque expressed on the generator side is:
\begin{equation}
    T^G=\frac{P_R}{\omega_G}=\frac{\frac{1}{2}\rho c_{P,MAX} \pi R^2 \left(\frac{n\omega_G R}{\lambda_{opt}}\right)^3}{\omega_G} = \frac{\rho c_{P, MAX} \pi R^5 }{2 \lambda_{opt}^3}n^3\omega_G^{2} = K_{opt}n^3\omega_G^{2}  \ \ \left[\si{\newton\meter}\right]
    \label{eq:T_G2}
\end{equation}

Since the $K_{opt}$ coefficient may be used for computing both the power and the torque, both on the generator an rotor side, having a table collecting the different relationships may be useful, and for this purpose \autoref{tab:gain_map} has been produced.
\begin{table}[htb]
    \centering
    \caption{Map for the use of torque constant}
    \begin{tabular}{ccc}
    \toprule
         & $\omega_R$ & $\omega_G$  \\ \midrule
         P & $K_{opt} \left(\omega_{R}\right)^3$ & $K_{opt}\left(n \omega_{G}\right)^3$\\
         $T_R$ & $K_{opt} \left(\omega_{R}\right)^2$ & $K_{opt}\left(n \omega_{G}\right)^2$\\
         $T_G$ & $K_{opt} n \left(\omega_{R}\right)^2$ &  $K_{opt} n^3\left(\omega_{G}\right)^2$\\ \bottomrule
    \end{tabular}
    \label{tab:gain_map}
\end{table}

 For the differences discussed above in the identification of the power coefficient and tip speed ratio, there is a small difference (1.9$\%$) between the $K_{opt}$ proposed from \cite{DTU_Wind_Energy_Report-I-0092} and the one computed by me, and again the one computed will be used in the simulation:
 \begin{gather*}
     K_{opt, report} = 1.001 \cdot 10^7 \ \ \ \left[\si{\newton\meter\square\second}\right] \\
     K_{opt, computed} = 1.020 \cdot 10^7 \ \ \ \left[\si{\newton\meter\square\second}\right] 
 \end{gather*}

 A deeper derivation may observe that the damping can be included in \autoref{eq:T_G1}:
 \begin{equation}
  T_G^{G} = \frac{P_G}{\omega_G} = \frac{P_R-B_{eq}(\omega_R)^2}{\omega_G} = K_{opt} - B_{eq}n^2\omega_G  
  \label{eq:T_G5}
 \end{equation}
 With this expression a more fine tracking of the power is possible, and it is particularly suitable to strictly enforce a desired velocity to the machine. The drawback of the approach is the necessity to know the value of the damping coefficient, which in principle is something that may be not available. For this reason, in the tested cases that will be proposed later, \autoref{eq:T_G1} will be used, unless otherwise explicitly specified.

\subsubsection[Above WS]{Generator's torque reference based on rotor above rated WS}
Above rated WS the objective is to keep the constant rotational speed and so the command:
\begin{equation}
    T_G^{G} = \frac{P_{G,rated}}{\omega_{G,rated}} = \frac{n\left(P_{R,rated}-B_{eq}\left(\omega_{rated}\right)\right)^2}{\omega_{R,rated}}\ \ \left[\si{\newton\meter}\right]
    \label{eq:T_G3}
\end{equation}
is given.

\subsubsection[Implementation details]{Implementation of the genereator's controller based on the rotor power}
In the Simulink model the implementation of the generator's torque reference $T_G^*$ is done employing a proportional gain and a saturation block. Following what is presented in \cite{Olimpo_Anaya‐Lara}, an intermediate block with a \acrshort{PI} controller uses the error between the reference generator mechanical input power $P_G^*$ and the actual one $P_G$ to set the generator torque. The control schema is presented in \autoref{fig:d_torque_control_2}.
\begin{figure}[htb]
    \centering
    \input{d_torque_control_2.tex}
    \caption{Scheme of the implemented active power torque controller}
    \label{fig:d_torque_control_2}
\end{figure}
The saturation block constraints the reference power in between $P_G^* \in \left[0, P_{G,rated}\right]$.
The values of the gains are \acrshort{kiP}$= 5.5$ and \acrshort{kpP}$=0.5$, according as \cite{Olimpo_Anaya‐Lara}. The integral action is chosen to be high to track the power commands, while the proportional gain helps to keep command and output in phase, at the cost of amplifying the high frequency part of the control signal.

\subsection{Generator's torque reference synthesis based on generator power}\label{subsec:method_control_P_GE}
Considering that the maximization of the harvested mechanical power not always corresponds to the maximization of the produced electrical power, then it may be interesting to quantify this difference, and possibly to propose a control strategy taking this it into account. The problem of possible mismatch between the powers has been identified also in \cite{VLAD2010305}, where some experimental results for a low-power wind energy systems are presented.\\
In this section a control approach based on the maximization of the power at the generator side of the driveline, rather than the rotor one, is proposed. Similarly to what was already done in \autoref{subsec:torque_reference}, also in this case two operational conditions are identified, between below and above the rated \acrshort{WS}.

First of all, an expression of the power at the output of the generator as function of theWS, the rotational speed, and the pitch angle through the power coefficient needs to be found. \\
Starting from a torque balance, the \textit{q-axis} current can be expressed as:
\begin{gather}
  T_G^G = n\left(T_R^R - B_{eq}^R\omega_R\right) = n\left(\frac{P_R}{\omega_R} - B_{eq}\omega_R\right) = n\left(\frac{A c_P \rho V_0^3 c_P(\theta, V_0, \omega_R)}{2\omega_R} - B_{eq}\omega_R\right) = \notag \\
   = \frac{3}{2}p\Lambda_{mg}i_q \Rightarrow iq = \frac{n\left(A \, c_P \, \rho \, V_0^3 \,-\,2B_{eq}{\omega_R}^2\right)}{3\omega_R\,p\,\Lambda_{mg}} 
\end{gather}
then it can be substituted in the expression of the steady state power at the generator:
\begin{gather}
  P_{GE} = P_{G} - \frac{3}{2} R_s i_q^2 = P_R - B_{eq}\omega_R^2 - \frac{3}{2} R_s i_q^2 = \\ \notag
  =\frac{\rho\pi R^2c_PV_0^3}{2} - B_{eq}\omega_R^2-\frac{3}{2}R_s\left(\frac{n\left(A \, c_P \, \rho \, V_0^3 \,-\,2B_{eq}{\omega_R}^2\right)}{3\omega_R\,p\,\Lambda_{mg}}\right)^2 \notag \label{eq:P_G_out_eq}
\end{gather}
where the $\frac{3}{2}$ factor is necessary to take into account that the transformation from the abc reference frame to the dq is not power invariant.\\
The tip speed ratio can be introduced:
\begin{gather}
  P_{GE} = \frac{\rho\pi R^2c_PV_0^3}{2} - B_{eq}\left(\frac{V0\lambda}{R}\right)^2-\frac{3}{2}R_s\left(\frac{n\left(A \, c_P \, \rho \, V_0^3 \,-\,2B_{eq}{\left(\frac{V0\lambda}{R}\right)}^2\right)}{3\left(\frac{V0\lambda}{R}\right)\,p\,\Lambda_{mg}}\right)^2 \label{eq:P_G_out_lambda}
\end{gather} 


\subsubsection[Below rated WS]{Generator's torque reference based on generator below rated WS}
In the case describe in \autoref{subsec:below_rotor} the choice of the reference values of TSR and pitch angle to be used below rated WS were based only on aerodynamical considerations, with the aim of maximizing the power extracted from the resource. In this case the same could not be done, and in principle it is not ensured that the TSR and the pitch are univocally identified. This has also the implication that the $K_{opt}$ used in the synthesis of the generator reference torque may be not univocally identified, and so the approach followed in \autoref{eq:T_G2} may be no longer valid. \\
To study the problem, a numerical method is employed. For a reasonably fine sampling of velocities in the considered range, the inverse of the power function has been minimized (i.e. equivalent to maximizing the power itself) with respect to the pitch angle and the TSR. The results are shown in \autoref{fig:parameters_for_below_rated}, alongside the corresponding counterpart found with the policy based on the rotor power maximization. The study has been repeated twice, considering or excluding the transmission damping. In fact, as could be seen in \autoref{eq:P_G_out_eq}, when the damping is not included in the picture, the output power is the input rotor power minus the joule loss (since in that case $T_R=T_G$).\\
An important assumption done here is that the rated WS is not changed with respect to the case of the $P_R$ maximization. This is done to make the comparison between the two control methods easier by preserving the same operating regions. This choice has an implication on the values of the nominal powers which requires a further explanation. In fact, during the definition of $V_{0,rated}$, after finding the optimal pitch angle and TSR, the power was computed with the cubic function of the WS, and then the velocity at which the rated power was reached identified. At this point, given the mechanical power, it was possible to retrieve the others (i.e. $P_G$ and $P_{GE}$). Now the steps followed are not exactly the same, since after obtaining the new pitch and TSR, the use of the power curve up to the previously rated WS leads to a $P_{GE}$ slightly different from the previous one, and thus to different $P_G$ and $P_R$. \autoref{tab:table_power} summarizes these differences. 
\begin{table}
  \centering
  \caption{Rated power values for the two control strategies}
  \begin{tabular}{cccc}
    \toprule
    & $P_R \, \mesunt{\mega\watt}$ & $P_G \, \mesunt{\mega\watt}$ & $P_{GE} \, \mesunt{\mega\watt}$\\ \midrule
    Rotor & 10.64 & 10.15 & 9.71 \\
    Generator & 10.53 & 10.07 & 9.62 \\
    \bottomrule
  \end{tabular}
  \label{tab:table_power}
\end{table}

\begin{figure}[H]
  \begin{subfigure}{0.5\textwidth}
    \centering
    \includegraphics[width=\textwidth]{images/vectorial/2023_11_12_17_56_46fig_lambda_GE.eps}
    \caption{Tip speed ratio}
    \label{fig:2023_06_24_15_57_04fig_lambda_GE}
  \end{subfigure}
  \begin{subfigure}{0.5\textwidth}
    \centering
    \includegraphics[width=\textwidth]{images/vectorial/2023_11_13_08_17_10fig_pitch_GE.eps}
    \caption{Optimal pitch angle}
    \label{fig:2023_06_24_15_57_04fig_pitch_GE}
  \end{subfigure}
  \begin{subfigure}{0.5\textwidth}
    \centering
    \includegraphics[width=\textwidth]{images/vectorial/2023_11_11_23_31_31fig_omega_GE.eps}
    \caption{Rotational speed}
    \label{fig:2023_07_10_14_18_25fig_omega_GE}
  \end{subfigure}
  \begin{subfigure}{0.5\textwidth}
    \centering
    \includegraphics[width=\textwidth]{images/vectorial/2023_11_11_23_31_31fig_cP_GE.eps}
    \caption{Power coefficient}
    \label{fig:2023_06_24_15_57_04fig_cP_GE}
  \end{subfigure}
  \begin{subfigure}{0.5\textwidth}
    \centering
    \includegraphics[width=\textwidth]{images/vectorial/fig_K_map.eps}
    \caption{$K_{opt}$ gain}
    \label{fig:fig_K_map}
  \end{subfigure}
  \caption{Comparison of the most important parameters for the operation below rated WS, where \textit{rotor} are quantities referred to the quantities identified basing on the rotor input power and \textit{generator} are the ones referred to the generator electrical power. This latter case is investigated with and without taking the damping into account.}
  \label{fig:parameters_for_below_rated}
\end{figure}

From the results in \autoref{fig:2023_06_24_15_57_04fig_lambda_GE} and \ref{fig:2023_06_24_15_57_04fig_pitch_GE}, it could be seen that the optimal TSR and pitch angle are not constant for any WS, and furthermore they do not change with a constant slope in the case of $B\neq0 \, \si{\kilo\gram\square\meter\per\second}$. In this latter case, a change in the slope is visible between $5\div5.5 \si{\meter \per\second}$. This could be explained remembering that the \autoref{eq:P_G_out_eq} contains the evaluation of a lookup table, that has to be in some way interpolated. For this specific application it has been seen that the use of the options $\texttt{cubic}$ in the $\texttt{interp2}$ Matlab function provides a smoother interpolation rather than the one obtained with the default option $\texttt{linear}$. Furthermore, since the minimization is performed with the Matlab's function $\texttt{fmincon}$, then the possible presence of local minima has to be taken into account by properly choosing the boundaries of the variables, that in this specific case have been set to $\lambda \in \left[7.5, 10\right]$ and $\theta\in\left[-5, 5\right] \si{\degree}$.  \\
Strictly speaking, this study states that the approach proposed in \autoref{eq:T_G2} is not longer valid because the gain $K_{opt}$ should be changed at different WS (as visible in \autoref{fig:fig_K_map}), which is possible only with the use of a proper sensor or estimator, never taken into account so far. Despite this, it could be seen that the variation of the two considered parameters is quite limited, and so the approximation of using a constant $K_{opt}$ is supposed to be still acceptable. The simplest choice for these parameters are their mean, but also more articulated choice may be possible, such as considering the wind speed distribution of the location where the turbine is going to be deployed and then considering the probability that each WS occurs during the year.\\
It is worth noting that this choice of $K_{opt}$ is expected to be less convenient when the mean value is further from the optimal speed-dependent ones, which corresponds to the lower and higher WSs. Hence it may be possible that for those WSs the control would not be able to realize the MPPT.\\ 
The numerical values of the parameters and the $K_{opt,GE}$ gains are computed with the \autoref{eq:K_opt_GE} and the numerical values are the ones reported in \autoref{tab:tab_k_opt_GE}, for both the assumptions on the damping. The subscription \textit{GE} stresses the fact that the gains are computed considering the power at the generator side rather than the rotor one.

\begin{equation}
  K_{opt,GE} = \frac{\rho \, \pi \, R^5 \, cp_{GE}}{2\lambda_{GE}^3} = 1.093\cdot10^7 \ \ \mesunt{\newton\meter\square\second}
  \label{eq:K_opt_GE}
\end{equation}

\begin{table}[htb]
  \centering
  \caption{Parameters for the control of the generator below rated WS}
  \begin{tabular}{ccccc}
    \toprule
    & $\lambda_{GE} \, \left[-\right]$ & $\theta \, \mesunt{\degree}$ & $cp_{GE} \, \left[-\right]$ & $K_{opt,GE} \, \mesunt{\newton\meter\square\second}$ \\ \midrule
    B=0 & 8.20 & 0.2328 & 0.4645 & $9.146 \cdot 10^6$\\
    $B\ne0$ & 7.73 & -0.272 & 0.4643 & $10.93 \cdot 10^6$\\ \bottomrule
  \end{tabular}
  \label{tab:tab_k_opt_GE}
\end{table}

\subsubsection[Above rated WS]{Generator's torque reference based on generator above WS}
Above rated WS, the definition of the new pitch angle map follows the same approach as in the previous case. A parametric study on the pitch angle has been done, meaning that for each WS, \autoref{eq:P_G_out_eq} has been applied to a set of pitch angles and then the one limiting $P_{GE}$ at the rated value has been identified. The results are shown in \autoref{fig:fig_new_pitch_map}.\\ 
 It could be seen that this control leads to a higher limitation of the angle, meaning that a lower $P_R$ is extracted from the wind, which is something expected since in this case the rated powers are lower than the ones in the case of maximization of the power at the rotor side.
\begin{figure}[H]
  \centering
  \includegraphics[width=0.5\textwidth]{images/vectorial/fig_new_pitch_map.eps}
  \caption{Power and pitch angle comparison between the control based on the aerodynamical power and the one based on the power output at the generator side}
  \label{fig:fig_new_pitch_map}
\end{figure}

\subsubsection[Implementation details]{Implementation details of the genereator's controller based on the power at the generator side}
In order to validate these strategies, the two controllers have been modified with respect to the previous tests:
\begin{itemize}
  \item PMSM control: in the schema \autoref{fig:d_torque_control_GE} with respect to the one in \autoref{fig:d_torque_control_2}, the newly computed  $K_{opt,GE}$ has been used%, and the mechanical input power to the generator $P_G$ has been replaced by the electrical power $P_{GE}$ in the feedback line
  \item Blade pitch control: the new value of rated rotational speed has been used instead of the old one in \autoref{fig:pitch_control}, and the initial condition of the integrator has been set to the newly identified mean pitch angle.
\end{itemize}

\begin{figure}[H]
  \centering
  \input{d_torque_control_GE.tex}
  \caption{Scheme of the implemented active power torque controller considering the generator.}
  \label{fig:d_torque_control_GE}
\end{figure}

\subsection{Generator's low level control}\label{subsec:generator_low_level-control}
Once the torque reference is synthesized according to the desired control law as described in \autoref{subsec:torque_reference} or \autoref{subsec:method_control_P_GE}, the first operation of the control scheme is to transform it in a $I_q \, \si{\ampere}$ current reference knowing that:
\begin{equation}
    T_G = \frac{3}{2}\Lambda_{mg} p I_q \ \ \left[\si{\newton\meter}\right]
    \label{eq:T_G4}
\end{equation}
where $\Lambda_{mg}$ is the permanent magnets flux $\left[\si{\weber}\right]$ and p is the number of pole pairs of the electrical machine.\\
Then the current is stabilized with the proper controller and finally the \autoref{eq:T_G4} is backwards applied to transform again $I_q$ into $T_G$. For simplicity, the chosen controller is a \acrfull{PID}. The feedback scheme has the structure reported in \autoref{fig:d_torque_control}.

\begin{figure}[H]
    \centering
    \input{d_torque_control.tex}
    \caption{Feedback scheme for torque control}
    \label{fig:d_torque_control}
\end{figure}

The transfer functions inside the loop are the regulator \acrshort{Riq}, the delay of the electronic necessary to the machine \acrshort{Gc} and the generator itself \acrshort{Yiq}. They are modelled as follow:
\begin{gather}
    R_{iq}=k_{p,iq} + \frac{k_{i,iq}}{s}+k_{d,iq}s=k_{i,iq}\left( \frac{k_{p,iq}}{k_{i,iq}} + \frac{1}{s} + \frac{k_{d,iq}}{k_{i,iq}}s \right) = \frac{k_{i,iq}}{s}\left(1+s\uptau_P\right)\left(1+s\uptau_I\right)
    \label{eq:R_iq}\\
    G_c = \frac{1}{1+\uptau_cs}
    \label{eq:G_c}\\
    Y_{iq} = -\frac{B_{eq} + J_{eq}s}{L_sJ_{eq}s^2+\left(R_sJ_{eq} + L_s B_{eq}\right)s + R_sB_{eq} + \frac{3}{2}(p\Lambda_{mg})^2}
    \label{eq:Y_iq}
\end{gather}
Where \acrshort{kpiq}, \acrshort{kiiq}, \acrshort{kdiq} are the proportional, integral and derivative gain respectively, \acrshort{tauc} is a time delay introduced by the power electronic converter, and $J_{eq}$ and $B_{eq}$ are the inertia and damping of the drivetrain respectively, for example as expressed in \autoref{eq:mech_eq}.\\
The design method used for tuning the PID controller is exposed in \autoref{sec:e_pid_tuning}. The chosen crossover frequency is \acrshort{omegacp}$=750 \, \si{\radian\per\second}$, which is less than $\frac{1}{6}$ of the switching one. This design choice is intended to limit the maximum changing rate of the control signal that may be followed by the controller. Moreover, to avoid the propagation of the high frequency dynamics, a further pole is added at a frequency one decade greater than the crossover one. \\
 The values of the gains ($k_{p,iq}$, $k_{i,iq}$, $k_{d,iq}$), the frequency of the added pole and the phase margin \acrshort{phiiq} are reported in \autoref{tab:tab_pid_tuning} alongside the same values computed from the Matlab frequency \texttt{pidtune}, that may be used to have at least the order of magnitude of the expected values.
\begin{table}[htb]
    \caption{Gains for the PMSM machine controller}
     \centering
     \begin{tabular}{cccccc}
     \toprule
          & $k_{p,iq}$ & $k_{i,iq}$ $\mesunt{\per\second}$ & $k_{d,iq}$ $\mesunt{\second}$ & $\uptau_{d1} \ \mesunt{\second}$ & $\varphi \mesunt{\degree}$\\ \midrule
         manual & \GenkpMacroMan & \GenkiMacroMan & \GenkdMacroMan & \GentaudOneMacroMan & \GenMarginMan\\
         \texttt{pidtune} & \GenkpMacroAuto & \GenkiMacroAuto & \GenkdMacroAuto & \GentaudOneMacroAuto & \GenMarginAuto\\ \bottomrule
     \end{tabular}
     \label{tab:tab_pid_tuning}
 \end{table}
 
 The Bode diagram of the open loop system without any controller (i.e. taking into account the shaft mechanical dynamic, the generator's electrical dynamic, and the inverter time delay), the open loop system with the controller, and the controller itself (see \autoref{fig:d_bode_TF}) are reported in \autoref{fig:fig_bode_generator}.
  \begin{figure}[H]
    \input{d_bode_TF.tex}
    \caption{Block diagram of the q-axis current control of a PMSM}
    \label{fig:d_bode_TF}
  \end{figure}
  \begin{figure}[H]
    \centering
    \includegraphics[width=0.75\textwidth]{images/vectorial/2023_10_2_16_06_13fig_bode_generator.eps}
    \caption{Bode plots of the open loop system, the controller and the controlled open loop system}
    \label{fig:fig_bode_generator}
   \end{figure}
  
 The bode plot of the close loop \acrshort{GCL} is shown in \autoref{fig:fig_bode_cl}. Given \acrshort{G} the direct transfer function (i.e. from input to output) and \acrshort{H} the feedback one, then the close loop transfer function is given by:
 \begin{gather}
     G_{CL}=\frac{G(s)}{1+G(s)H(s)}=\frac{R_{iq}(s)G_c(s)Y_{iq}(s)}{1+R_{iq}(s)G_c(s)Y_{iq}(s)}
     \label{eq:close_loop_TF}
 \end{gather}
 where $R_{iq}(s)$, $G_c(s)$, $Y_{iq}(s)$, and $H(s)=1$ since there is no transfer function on the feedback line.
 

 \begin{figure}[H]
    \centering
    \includegraphics[width=0.75\textwidth]{images/vectorial/2023_10_2_16_06_31fig_bode_cl.eps}
    \caption{Bode plot of the generator close loop transfer function}
    \label{fig:fig_bode_cl}
 \end{figure}

Furthermore, the response of the close loop system to a q-axis current step input is reported in \autoref{fig:step_response}. It could be seen that the integral actions drives the steady state error to 0, while the produced overshoot is quite limited (less than 1\%). 

\begin{figure}[H]
  \centering
  \includegraphics[width=0.75\textwidth]{images/vectorial/2023_10_2_15_44_16generator_step_input.eps}
  \caption{Time response of the controlled generator at the input step of the reference q-axis current}
  \label{fig:step_response}
\end{figure}

\subsection{Pitch controller}
In this simple model, the \textit{collective} pitching strategy is employed, meaning that all the blades are rotated of the same quantity.\\
As suggested in \cite{Aerodynamics_of_wind_turbines} and \cite{SMILDEN2016386}, the pitch controller has two different behaviors in the operational regions, and so in a wide sense it is a non-linear one: below rated \acrshort{WS}, it has not to be activated at all, while in the full load region it has to pitch the blade in order to drive the rotational speed to rated value. Its Simulink implementation has been done as reported in \autoref{fig:pitch_control}.
\begin{figure}[H]
    \centering
    \input{d_blade_control}
    \caption{Block diagram of the pitch controller. The saturation block limits the pitch angle between 0 and the maximum pitching angle allowed by the mechanical constraints on actuators}
    \label{fig:pitch_control}
\end{figure}

The core part of the controller is a \acrfull{PI} action driven by the speed error defining the pitch angle. A saturation block on the pitch angle is used to impose the mechanical constraints, so to limit the blade rotation within $\theta \in \left[0, 90\right] \si{\degree}$. The lower threshold prevents that a negative speed error produces a pitching towards stalling.

The tuning of this PI is not straightforward because the system to be controlled is not linear, and so the standard techniques cannot be implemented. In particular, at high wind speeds the aerodynamic loads are more sensitive to changes in the angles of attack, and so the change in pitch should be limited \cite{Aerodynamics_of_wind_turbines}. A possible solution is to treat the turbine as a linear varying-parameter system and schedule the gain during the operation of the mechanism, for example based on one state of the system itself, assuming that this state changes slowly compared to the controlled dynamic. This is an advantageous choice, because the approach simplifies the description of the system and does not require a lot of measurements. A frequently made choice is to use the pitch angle itself to schedule the gains, \cite{Olimpo_Anaya‐Lara}, \cite{DTU_Wind_Energy_E_0028}, \cite{NREL_5MW_reference}. In \autoref{subsec:gain_poly} a gain scheduling law proposed in the literature is reported, while \autoref{subsec:gain_schdeuling_aero} briefly describes how to compute the gains starting from the aerodynamic. In this latter case, the procedure is initially validated on the NREL 5 MW in \autoref{subsec:gain_schdeuling_NREL5MW} and then applied to the DTU 10 MW in \autoref{subsec:gain_schdeuling_DTU10MW}.\\
As final remark, \cite{Olimpo_Anaya‐Lara} using the actual pitch angle as scheduling variable violates the assumption that the scheduling parameter evolves slower compared to the controlled dynamic, and so it may not behave as expected in the vicinity of the rated WS, which is where the sensitivity to the gain changes are stronger.

\subsubsection[With scheduling from literature]{Control of the blade pitch angle with data from literature}\label{subsec:gain_poly}       
Specifically for the DTU 10 MW, \cite{Olimpo_Anaya‐Lara} proposes the schedule based on the polynomials in \autoref{eq:k_p_poly} and \ref{eq:k_i_poly} for \acrshort{kp} and \acrshort{ki} respectively:
\begin{gather}
    k_p(\theta)=1.000-2.541 \ \theta-7.814 \ \theta^2+46.281 \ \theta^3-59.871 \ \theta^4
    \label{eq:k_p_poly}\\
    k_i(\theta)=0.351-2.405 \ \theta+13.128 \ \theta^2-31.926 \ \theta^3+27.689 \ \theta^4
    \label{eq:k_i_poly}
\end{gather}
with $\theta$ in $\left[\si{\radian}\right]$. For a more practical visualization these polynomials have been plotted in \autoref{fig:fig_gain_schduling}, where it can be seen that a great variation of the coefficients happens in between the minimum and maximum angles.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{images/vectorial/fig_gain_scheduling.eps}
    \caption{Proportional and integral gains for blade's controller as function of pitch angle, simplified approach from \cite{Olimpo_Anaya‐Lara}}
    \label{fig:fig_gain_schduling}
\end{figure}

Another option could have been to schedule the pitch based on the \acrshort{WS} itself, but this would have required a direct measurement of the resource. 

\subsubsection[With scheduling from aerodynamic]{Procedure for computing the blade pitch controller gains starting from the aerodynamic}\label{subsec:gain_schdeuling_aero}
As described in \cite{Aerodynamics_of_wind_turbines}, \cite{NREL_5MW_reference}, and \cite{ris_r_1500} applying a linearization of the \autoref{eq:mech_eq} and further mathematical manipulations that are out of the scope of this thesis,  the gains may be expressed in close form as:
\begin{gather}
    GK(\theta) = \frac{1}{1+\frac{\theta}{\theta_K}} \label{eq:GK}\\
    k_p(\theta) = \frac{2J_{eq}\omega_{rated}\zeta_{\Phi}\omega_{\Phi\eta}}{\frac{1}{n}\left(-\frac{dP_R(\theta)}{d\theta}\right)\vert_{\theta=0}}GK(\theta)
    \label{eq:kp}\\
    k_i(\theta) = \frac{J_{eq}\omega_{rated}\omega_{\Phi\eta}^2}{\frac{1}{n}\left(-\frac{dP_R(\theta)}{d\theta}\right)\vert_{\theta=0}}GK(\theta)
    \label{eq:ki}
\end{gather}
where $J_{eq}$ is the inertia of the drivetrain on the low speed shaft, $\omega_{rated}$ is the rotational speed of the low speed shaft at rated power, \textit{n} is the gear ratio, \acrshort{zetaphi} and \acrshort{omegaphieta} are the damping ratio and the resonant frequency of the second order dynamic response of the idealized PI-controlled rotor-speed error (source \cite{NREL_5MW_reference}), and \acrshort{thetaK} is a parameter related to the pitch sensitivity and will be further discussed in \autoref{subsec:gain_schdeuling_NREL5MW}. \cite{NREL_5MW_reference} suggests to take $\omega_{\Phi\eta}=0.6\si{\radian\per\second}$ and $0.6<\zeta_{\Phi}<0.7$. The most complicated term to be computed is the sensitivity of the power with respect to the pitch angle $-\frac{dP_R}{d\theta}$. Its estimation should be done applying a steady \acrshort{BEM} (also known as \textit{Frozen wake BEM}) as reported in \cite{Aerodynamics_of_wind_turbines} or with specific software. \\
The frozen wake BEM is implemented in two steps, then repeated for all the \acrshort{WS} between the rated and the cut out one. In the first one, the standard BEM presented in \autoref{subsec:BEM_algorithm} is applied on the blade, considering that it is pitched as to produce the rated power (i.e. the pitch angle is the one scheduled in \autoref{subsec:pitch_map}). In this step the induction coefficients \textit{a} and \textit{$a_{prime}$} found are stored. In the second step, the previously described BEM is applied but the pitch angle is changed on a set around the optimal one, while the induction coefficients are kept constant (i.e. they are not computed with the iterative procedure). The power is then computed for each pitch angle and finally the power derivative with respect to the pitch angle is obtained applying a numerical differentiation method.

\subsubsection{Validation of the procedure for the pitch gains on the NREL 5 MW}\label{subsec:gain_schdeuling_NREL5MW}
In order to validate the procedure, the gains are initially computed for the NREL 5 MW turbine because more intermediate steps are available in literature \cite{NREL_5MW_reference}.\\
The derivative of the power computed at the expected pitch angle is  reported in \autoref{fig:fig_dPdtheta}, alongside its interpolation done by a first and second order polynomials. It could be seen that the second order approximation seems to better follow the trend of the computed points with respect to the first order one. 
\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{images/fig_dPdtheta.eps}
    \caption{Aerodynamic power gain for the NREL 5MW WT}
    \label{fig:fig_dPdtheta}
\end{figure}

The interpolations are used to find two important parameters, called $\theta_{K}$ and  $-\frac{dP_R(\theta)}{d\theta}\vert_{\theta=0}$. The first is the blade-pitch angle at which the pitch sensitivity is twice the value at the rated operating point, while the second is the pitch sensitivity at 0 pitch (i.e. the intercept of the interpolation). For the turbine under investigations, these two parameters are $\theta_K=10.25 \si{\degree}$ and  $\frac{dP_R(\theta)}{d\theta}\vert_{\theta=0} = -29.15 \si{\mega\watt\per\radian}$, while the ones reported in the report are $\theta_K=6.3 \si{\degree}$ and  $-\frac{dP_R(\theta)}{d\theta}\vert_{\theta=0} = -25.52\si{\mega\watt\per\radian}$ (for the linear case). These values seem to be reasonably close each other.\\ 
Once all the terms in \autoref{eq:ki}, \ref{eq:kp}, and \ref{eq:GK} are available and the gain scheduling can be determined, and the comparison reported in \autoref{fig:fig_gain_pitch}.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.65\textwidth]{images/fig_gain_pitch.eps}
    \caption{Comparison between the computed gain coefficients and the one presented in \cite{NREL_5MW_reference} for the NREL 5 MW}
    \label{fig:fig_gain_pitch}
\end{figure}


\subsubsection{Use of the procedure for the pitch gains on the DTU 10 MW}\label{subsec:gain_schdeuling_DTU10MW}
The procedure described in the \autoref{subsec:gain_schdeuling_NREL5MW} is applied on the DTU 10 MW. For this turbine, there are less intermediate steps that can be used to cross check the procedure itself. \cite{DTU_Wind_Energy_E_0028} reports the second order interpolation of the aerodynamic torque gain, which is linked to the aerodynamic power gain since the velocity is constant above rated WS. This is here reported in \autoref{fig:fig_torque_gain_DTU10MW}.
\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{images/fig_torque_gain_DTU10MW.eps}
    \caption{Aerodynamic torque gain for the DTU 10 MW as in \cite{DTU_Wind_Energy_E_0028}}
    \label{fig:fig_torque_gain_DTU10MW}
\end{figure}

Furthermore the pitch gains are reported in \autoref{fig:fig_gain_sched_DTU10MW} alongside the polynomial interpolations proposed by \cite{Olimpo_Anaya‐Lara}, and reported in \autoref{subsec:gain_poly}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{images/fig_gain_sched_DTU10MW.eps}
    \caption{Comparison between the gains computed from the aerodynamic and the ones from the simplified approach}
    \label{fig:fig_gain_sched_DTU10MW}
\end{figure}

Even though the results of the aerodynamic torque gain and the pitch gains are not exactly the same as the reference cited in \autoref{fig:fig_torque_gain_DTU10MW} and \autoref{fig:fig_gain_sched_DTU10MW}, they are very close to the one presented by \cite{Galinos_2019}, which also has made the same assumption of stiff blade. This can be taken as a reasonable validation of the procedure.
\subsection{Low pass filtering of the rotor speed}
As presented in \cite{Olimpo_Anaya‐Lara}, in order to prevent the feeding into the control loop of high frequency dynamic, the rotor rotational speed is low pass filtered before being used in both the torque and the pitch controllers. According to the same source, this filter has an important influence on the pitching dynamics since if it is tuned too low then the performance of the rotor speed control decays due to phase offset between the actual and filtered speed measurements but, on the other hand, if it is too high the pitch mechanism may react to aerodynamic excitation even when it would be not necessary. \\
The proposed filter's transfer function is:
\begin{equation}
    G = \frac{1}{1+\frac{s}{\alpha_{\beta}}} =  \frac{1}{1+\frac{s}{2\pi0.4}}
    \label{eq:filter_pitch}
\end{equation}
with the choice of $\alpha_{\beta}=0.4 \left[\si{\hertz}\right] = 2\pi0.4 \left[\si{\radian\per\second}\right]$. 

